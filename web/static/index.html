<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIS Vessel Tracker</title>

    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@9.2.5/dist.min.js"></script>

    <!-- Tabulator -->
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

    <!-- uPlot -->
    <link href="https://unpkg.com/uplot@1.6.30/dist/uPlot.min.css" rel="stylesheet">
    <script src="https://unpkg.com/uplot@1.6.30/dist/uPlot.iife.min.js"></script>

    <!-- Import map for ES modules -->
    <script type="importmap">
    {
        "imports": {
            "@preact/signals-core": "https://esm.sh/@preact/signals-core@1.8.0"
        }
    }
    </script>

    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app">
        <!-- Header with global controls -->
        <header id="header">
            <h1>AIS Vessel Tracker</h1>
            <div id="connection-status" class="disconnected">
                <span class="status-dot"></span>
                <span class="status-text">Disconnected</span>
            </div>

            <!-- Global timeline slider -->
            <div id="timeline-control">
                <input type="range" id="timeline-slider" min="0" max="100" value="100">
                <span id="timeline-label">Now</span>
            </div>

            <div id="stats">
                <span id="vessel-count">0 vessels</span>
                <span id="message-count">0 messages</span>
            </div>

            <div id="map-controls">
                <button id="locate-btn" title="Center on my location">My Location</button>
                <button id="names-btn" title="Toggle vessel names">Names</button>
                <select id="style-selector">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="voyager">Voyager</option>
                </select>
                <button id="settings-btn" title="Settings">‚öô</button>
                <button id="menu-toggle" title="Toggle vessel list">‚ò∞</button>
            </div>
        </header>

        <!-- Main content area: map + sidebar -->
        <main id="main">
            <!-- Map panel -->
            <div id="map-panel">
                <div id="map-container"></div>
            </div>

            <!-- Sidebar resize handle -->
            <div id="sidebar-resize"></div>

            <!-- Sidebar backdrop for mobile -->
            <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

            <!-- Sidebar with hierarchical navigation -->
            <aside id="sidebar">
                <!-- Navigation header -->
                <div id="sidebar-nav">
                    <button id="nav-back" class="hidden" title="Back">‚Üê</button>
                    <span id="nav-title">Vessels</span>
                    <button id="sidebar-close" title="Close">√ó</button>
                </div>

                <!-- View container - each view replaces the previous -->
                <div id="sidebar-views">
                    <!-- Level 1: Vessels list (default) -->
                    <div id="view-vessels" class="sidebar-view active">
                        <div id="search-box">
                            <input type="text" id="search-input" placeholder="Search vessels...">
                        </div>
                        <div id="type-filters">
                            <button class="type-chip active" data-type="all">All</button>
                            <button class="type-chip" data-type="passenger">Pass</button>
                            <button class="type-chip" data-type="cargo">Cargo</button>
                            <button class="type-chip" data-type="tanker">Tank</button>
                            <button class="type-chip" data-type="fishing">Fish</button>
                            <button class="type-chip" data-type="tug">Tug</button>
                            <button class="type-chip" data-type="aton">AtoN</button>
                            <button class="type-chip" data-type="other">Other</button>
                        </div>
                        <div id="vessel-table"></div>
                    </div>

                    <!-- Level 2: Vessel detail -->
                    <div id="view-vessel-detail" class="sidebar-view">
                        <div id="vessel-details"></div>
                        <div class="detail-actions">
                            <button id="zoom-to-vessel" class="action-btn action-btn-inline">
                                <span class="action-icon">üîç</span>
                                <span>Zoom to Vessel</span>
                            </button>
                            <button id="show-vessel-messages" class="action-btn">
                                <span class="action-icon">üì®</span>
                                <span>View Messages</span>
                                <span class="action-arrow">‚Üí</span>
                            </button>
                            <button id="show-vessel-track" class="action-btn">
                                <span class="action-icon">üìç</span>
                                <span>Track History</span>
                                <span class="action-arrow">‚Üí</span>
                            </button>
                        </div>
                    </div>

                    <!-- Level 3: Vessel messages -->
                    <div id="view-vessel-messages" class="sidebar-view">
                        <div id="vessel-messages-controls">
                            <div id="vessel-messages-search">
                                <input type="text" id="vessel-messages-search-input" placeholder="Search messages...">
                            </div>
                            <div id="vessel-messages-time-filter">
                                <select id="vessel-messages-hours">
                                    <option value="1">1 hour</option>
                                    <option value="6">6 hours</option>
                                    <option value="24" selected>24 hours</option>
                                    <option value="168">7 days</option>
                                    <option value="">All time</option>
                                </select>
                            </div>
                        </div>
                        <div id="vessel-messages-header">
                            <span id="vessel-messages-count">0 messages</span>
                            <span id="vessel-messages-sort-hint">Click Time to sort</span>
                        </div>
                        <div id="vessel-messages-table"></div>
                        <div id="vessel-messages-pagination">
                            <button id="vessel-messages-prev" disabled>‚Üê Prev</button>
                            <span id="vessel-messages-page-info">Page 1</span>
                            <button id="vessel-messages-next" disabled>Next ‚Üí</button>
                        </div>
                        <!-- Message detail panel -->
                        <div id="message-details" class="hidden"></div>
                    </div>

                    <!-- Alternate top level: All messages -->
                    <div id="view-all-messages" class="sidebar-view">
                        <div id="message-table"></div>
                    </div>
                </div>

                <!-- Bottom tabs for quick access -->
                <div id="sidebar-tabs">
                    <button class="sidebar-tab active" data-view="vessels" title="Vessels">
                        <span class="tab-icon">üö¢</span>
                        <span class="tab-label">Vessels</span>
                    </button>
                    <button class="sidebar-tab" data-view="all-messages" title="Messages">
                        <span class="tab-icon">üì®</span>
                        <span class="tab-label">Messages</span>
                    </button>
                </div>
            </aside>
        </main>

        <!-- Bottom charts panel -->
        <div id="charts-panel" class="hidden">
            <!-- Mobile drag handle -->
            <div id="charts-handle">
                <div class="handle-pill"></div>
            </div>
            <div id="charts-resize"></div>
            <!-- Mobile chart indicator pills -->
            <div id="charts-indicators">
                <button class="chart-pill active" data-chart="speed">Speed</button>
                <button class="chart-pill" data-chart="course">Course</button>
                <button class="chart-pill" data-chart="draught">Draught</button>
            </div>
            <div id="charts-container">
                <div id="speed-chart-wrapper" data-chart="speed">
                    <div class="chart-label">Speed (kts)</div>
                    <div id="speed-chart"></div>
                </div>
                <div id="course-chart-wrapper" data-chart="course">
                    <div class="chart-label">Course (¬∞)</div>
                    <div id="course-chart"></div>
                </div>
                <div id="draught-chart-wrapper" data-chart="draught">
                    <div class="chart-label">Draught (m)</div>
                    <div id="draught-chart"></div>
                </div>
            </div>
            <!-- Mobile time scrubber -->
            <div id="time-scrubber">
                <input type="range" id="time-scrubber-input" min="0" max="100" value="100">
                <div id="time-scrubber-label">Now</div>
            </div>
            <!-- Highlight info shows when hovering on charts -->
            <div id="highlight-info" class="hidden"></div>
        </div>
    </div>

    <!-- Mobile global timeline (shown when no vessel selected) -->
    <div id="mobile-timeline" class="hidden">
        <div class="mobile-timeline-label">Timeline</div>
        <input type="range" id="mobile-timeline-slider" min="0" max="100" value="100">
        <div id="mobile-timeline-value">Now</div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" title="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Display</h3>
                    <div class="setting-row">
                        <label for="setting-vessel-age">Show vessels active within:</label>
                        <select id="setting-vessel-age">
                            <option value="60">1 minute</option>
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="1800">30 minutes</option>
                            <option value="3600">1 hour</option>
                            <option value="-1">All time</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>
                            <input type="checkbox" id="setting-show-names">
                            Show vessel names on map
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Charts</h3>
                    <div class="setting-row">
                        <label>
                            <input type="checkbox" id="setting-chart-speed" checked>
                            Speed chart
                        </label>
                    </div>
                    <div class="setting-row">
                        <label>
                            <input type="checkbox" id="setting-chart-course" checked>
                            Course chart
                        </label>
                    </div>
                    <div class="setting-row">
                        <label>
                            <input type="checkbox" id="setting-chart-draught" checked>
                            Draught chart
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="settings-reset" class="btn-secondary">Reset to Defaults</button>
                <button id="settings-save" class="btn-primary">Save</button>
            </div>
        </div>
    </div>

    <script type="module" src="/static/app.js"></script>
</body>
</html>
